<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="PSM Inventory">
    <meta name="author" content="Ardhiansyah">

    <title>User Management</title>
	
	<!-- Fav icon -->
	<link rel="icon" href="img/fav.png" type="image/png">

    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
             <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon ">
                    <img src="img/logovale.png" alt="Logo" class="logo" style="width: 60px; height: 50px;"/>
                </div>
                <div class="sidebar-brand-text mx-3">E-Stock</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Input data
            </div>

            <!-- Nav Item - Pages Collapse Menu - Data Barang -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                    aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-box"></i>
                    <span>Data Barang</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Data Stocklist :</h6>
                        <a class="collapse-item" href="souvenir.html">Souvenir</a>
                        <a class="collapse-item" href="ppe.html">PPE</a>
						<a class="collapse-item" href="office.html">Office Support</a>
                    </div>
                </div>
            </li>
			
			 <!-- Nav Item - Data Suplier -->
            <li class="nav-item">
				<a class="nav-link" href="supplier.html">
					<i class="fas fa-fw fa-truck"></i>
					<span>Supplier</span>
				</a>
			</li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item active">
                <a class="nav-link" href="user.html">
					<i class="fas fa-fw fa-user-plus"></i>
					<span>Users</span>
				</a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">


            <!-- Nav Item - Sidebar toggle -->
            <div class="text-center d-none d-md-inline">
				<button class="rounded-circle border-0" id="sidebarToggle"></button>
			</div>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- Sidebar Toggle (Topbar) -->
                    <form class="form-inline">
                        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                            <i class="fa fa-bars"></i>
                        </button>
                    </form>
					
					<!-- Page Heading -->
                    <div class="d-flex align-items-center justify-content-center mb-1">
                        <h1 class="h3 mb-1 text-gray-800">User Management</h1>
                    </div>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">

                    <!-- Nav Item-Kanan-atas: user info dinamis -->
					<div id="user-menu-root" class="nav-item dropdown no-arrow"></div>	
                    </ul>
                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- DataTales Example -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
						
							<!-- Modal Add/Edit User (tanpa password) -->
							<button id="btnAdd" type="button" class="btn btn-primary mb-1" data-toggle="modal" data-target="#addSouvenirModal">Add New User</button>
							
							
							<div class="modal fade" id="modalUser" tabindex="-1" role="dialog" aria-labelledby="addSouvenirModalLabel" aria-hidden="true">
								<div class="modal-dialog" role="document">
									<form id="formUser">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title" id="modalTitle">Add New User</h5>
												<input type="hidden" name="uid" />
												<button type="button" class="close" data-dismiss="modal" aria-label="Close">
													<span aria-hidden="true">&times;</span>
												</button>
											</div>
											<div class="modal-body">
											
												<!-- Form fields -->
												<div class="form-group">
													<label>Email</label>
													<input name="email" type="email" class="form-control" required />
												</div>
												<div class="form-group">
													<label>Nama (opsional)</label>
													<input name= "displayName" type="text" class="form-control" />
												</div>
												<div class="form-group">
													<label>Role</label>
													<select type="text" class="form-control" required>
														<option value="admin">Admin</option>
														<option value="contributor">Contributor</option>
														<option value="viewer">Viewer</option>
													</select>
													<p id="formHint" style="font-size:12px;color:#666;margin-top:.5rem;">
													  Setelah dibuat, kirim link reset password ke email user.
													</p>
												</div>
											</div>
										</div>
									</form>
								</div>
							</div>
                        </div>
						
						<!-- Tabel User -->
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id= "tblUsers" class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
											<th>Nama</th>
											<th>Role</th>
											<th>Status</th>
											<th>Dibuat</th>
											<th>Last Sign-in</th>
											<th style="width:220px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyUsers"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Production System Management 2025</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>
   

	<!-- Script Module -->
	<script type="module">
		'use strict';
      import { guardPage } from '/js/auth-guard.js';
	  import { mountUserMenu } from '/js/user-menu.js';
	  import { app, auth, db } from '/js/firebase-init.js';
	  import {
	    onAuthStateChanged,
	    updatePassword,
	    EmailAuthProvider,
	    reauthenticateWithCredential,
	    sendPasswordResetEmail
	  } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
	  import {
		collection, doc, getDoc, setDoc, updateDoc, writeBatch,
		onSnapshot, serverTimestamp, query, orderBy
	  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    
    // 1) Proteksi halaman only for admin
    guardPage({ allow: ['admin'], redirectIfDenied: './index.html' }); 

    // 2) Pasang user menu (tampilkan badge role)
		mountUserMenu({
		    rootSelector: "#user-menu-root",
		    profileUrl: "./profile.html",
		    aboutUrl: "./about.html",
		    loginUrl: "./login_main.html",
		});

	  
/***********************
   * 2) Helper DOM & Pencarian Elemen Eksisting
   ***********************/
  const $ = (sel, parent=document) => parent.querySelector(sel);

  // Cari tombol "Add New User" tanpa ubah HTML:
  function findAddUserButton() {
    // Prioritas: id/data-attr yang umum
    let el = document.getElementById('btnAddUser') 
          || document.querySelector('[data-action="add-user"]');
    if (el) return el;

    // Fallback: cari berdasarkan teks
    const candidates = document.querySelectorAll('button, a, [role="button"]');
    for (const n of candidates) {
      const t = (n.textContent || '').trim().toLowerCase();
      if (t === 'add new user' || t === 'add user') return n;
    }
    return null;
  }

  // Cari modal & form Add yang sudah ada di halaman Mas
  function findAddUserModal() {
    const modal = document.getElementById('addUserModal') 
               || document.querySelector('[data-modal="add-user"]');
    const form  = document.getElementById('addUserForm') 
               || modal?.querySelector('form');
    const btnClose = document.getElementById('btnCloseModal') 
                  || document.getElementById('btnCloseModal2') 
                  || modal?.querySelector('[data-action="close-modal"]');
    return { modal, form, btnClose };
  }

  // Tabel pertama di halaman dipakai sebagai tabel user
  const table = document.querySelector('table');
  if (!table) console.warn('Tidak ditemukan <table> pada halaman.');
  const tbody = table?.querySelector('tbody') || table?.appendChild(document.createElement('tbody'));

  // Modal show/hide mengikuti CSS Mas (pakai class 'hidden' bila ada, + display)
  function show(el) { if (!el) return; el.classList?.remove('hidden'); el.style.display = 'block'; }
  function hide(el) { if (!el) return; el.classList?.add('hidden');  el.style.display = 'none'; }

  const fmtTime = (ts) => {
    try { return ts?.toDate ? ts.toDate().toLocaleString() : '-'; } catch { return '-'; }
  };

  /***********************
   * 3) Render Baris Tabel
   ***********************/
  function renderRow(u) {
    const tr = document.createElement('tr');
    const roleText = u.role || 'viewer';
    const statusText = u.disabled ? 'Disabled' : 'Enabled';

    tr.innerHTML = `
      <td>${u.email ?? '-'}</td>
      <td>${u.displayName ?? '-'}</td>
      <td class="col-role" data-uid="${u.id}">
        <span class="role-text">${roleText}</span>
      </td>
      <td class="status" data-uid="${u.id}">${statusText}</td>
      <td>${fmtTime(u.createdAt)}</td>
      <td>${fmtTime(u.lastSignInTime)}</td>
      <td>
        <button class="btn-edit"   data-uid="${u.id}">Edit</button>
        <button class="btn-reset"  data-email="${u.email}">Reset Password</button>
        <button class="btn-delete" data-uid="${u.id}">Delete</button>
      </td>
    `;
    return tr;
	 }

	  // Masuk ke mode edit pada kolom Role
	  function enterEditRole(cell, uid, currentRole) {
		if (!cell || cell.dataset.editing === 'true') return;
		cell.dataset.editing = 'true';
		cell.innerHTML = `
		  <select class="role-select" data-uid="${uid}">
			<option value="viewer" ${currentRole==='viewer'?'selected':''}>Viewer</option>
			<option value="contributor" ${currentRole==='contributor'?'selected':''}>Contributor</option>
			<option value="admin" ${currentRole==='admin'?'selected':''}>Admin</option>
		  </select>
		  <button class="btn-save"   data-uid="${uid}">Save</button>
		  <button class="btn-cancel" data-uid="${uid}">Cancel</button>
		`;
	  }

	  // Keluar dari mode edit (kembali ke teks)
	  function exitEditRole(cell, newRole) {
		if (!cell) return;
		cell.dataset.editing = 'false';
		cell.innerHTML = `<span class="role-text">${newRole}</span>`;
	  }

	  /***********************
	   * 4) Load Data Users (list) & Binding Actions
	   ***********************/
	  onAuthStateChanged(auth, async (user) => {
		if (!user) { window.location.href = 'login_main.html'; return; }

		// Ambil role dari /users/{uid} (sesuai rules asli Mas)
		try {
		  const me = await getDoc(doc(db, 'users', user.uid));
		  if (!me.exists()) {
			console.warn('Dokumen user login belum ada. Pastikan dibuat saat onboarding.');
		  }
		} catch (err) {
		  console.warn('Gagal membaca profil login:', err?.message || err);
		}

		// LIST users (rules: hanya admin yang boleh list)
		if (tbody) {
		  const qUsers = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
		  onSnapshot(qUsers, {
			next: (snap) => {
			  tbody.innerHTML = '';
			  snap.forEach(d => {
				const data = d.data();
				if (data.deletedAt) return; // sembunyikan soft-deleted
				tbody.appendChild(renderRow({ id: d.id, ...data }));
			  });
			},
			error: (err) => {
			  console.warn('Gagal list users:', err?.message || err);
			  tbody.innerHTML = '<tr><td colspan="7">Tidak punya izin melihat daftar users.</td></tr>';
			}
		  });
		}

		// ===== A. ADD NEW USER (pakai elemen eksisting Mas) =====
		const addBtn = findAddUserButton();
		const { modal, form, btnClose } = findAddUserModal();

		addBtn?.addEventListener('click', () => show(modal));
		btnClose?.addEventListener('click', () => hide(modal));

		form?.addEventListener('submit', async (e) => {
		  e.preventDefault();
		  try {
			const email = form.querySelector('input[name="email"]')?.value?.trim();
			const password = form.querySelector('input[name="password"]')?.value;
			const displayName = form.querySelector('input[name="displayName"]')?.value?.trim();
			const role = form.querySelector('input[name="role"]:checked')?.value || 'viewer';
			if (!email || !password) { alert('Email & password wajib diisi'); return; }

			// Karena Mas tidak mau ubah halaman/struktur, kita TIDAK membuat secondary app di sini
			// (opsi create user via client akan menimpa sesi admin).
			// Rekomendasi aman (tanpa ubah halaman lain):
			//  - Admin menambahkan data user ke koleksi `users` (supaya tampil dulu di tabel)
			//  - User akan melakukan signup/login sendiri (atau admin buat manual via Console)
			//  - Setelah user ada, role sudah siap di `users/{uid}` untuk diatur via Edit
			// Jika Mas tetap ingin auto-create akun Auth dari halaman ini tanpa logout admin,
			// beri izin saya untuk menambahkan inisialisasi "secondary app" beberapa baris di sini.

			alert('Untuk menjaga sesi admin, pembuatan akun Auth disarankan via Console atau izinkan secondary app.\nData user akan dibuat di Firestore terlebih dahulu.');

			// Simpan placeholder di Firestore agar user masuk ke list (tanpa UID Auth)
			// NOTE: tanpa UID, ini hanya placeholder. Nanti setelah user login pertama kali, UID-nya berbeda.
			// Direkomendasikan: create user Auth via Console lalu doc users/{uid} dibuat/diupdate.
			const tempId = `temp_${Date.now()}`;
			await writeBatch(db)
			  .set(doc(db, 'users', tempId), {
				email, displayName: displayName || '', role, disabled: false,
				createdAt: serverTimestamp()
			  })
			  .commit();

			hide(modal);
			form.reset();
		  } catch (err) {
			console.error(err);
			alert('Gagal menambah user.');
		  }
		});

		// ===== B. ACTIONS di tabel =====
		table?.addEventListener('click', async (e) => {
		  const t = e.target;

		  // Edit → masuk mode edit role
		  if (t.classList.contains('btn-edit')) {
			const uid = t.dataset.uid;
			const cell = t.closest('tr')?.querySelector('.col-role');
			const cur = cell?.querySelector('.role-text')?.textContent?.trim() || 'viewer';
			enterEditRole(cell, uid, cur);
		  }

		  // Save role
		  if (t.classList.contains('btn-save')) {
			const uid = t.dataset.uid;
			const row = t.closest('tr');
			const cell = row?.querySelector('.col-role');
			const select = cell?.querySelector('.role-select');
			const newRole = select?.value || 'viewer';
			try {
			  const batch = writeBatch(db);
			  batch.update(doc(db, 'users', uid), { role: newRole });
			  await batch.commit();
			  exitEditRole(cell, newRole);
			  alert('Role berhasil disimpan.');
			} catch (err) {
			  console.error(err);
			  alert('Gagal menyimpan role. Cek Rules/izin.');
			}
		  }

		  // Cancel edit role
		  if (t.classList.contains('btn-cancel')) {
			const row = t.closest('tr');
			const cell = row?.querySelector('.col-role');
			const prev = cell?.getAttribute('data-prev')
					  || cell?.querySelector('.role-select')?.getAttribute('data-prev')
					  || 'viewer';
			const curText = row?.querySelector('.role-select')?.value || prev;
			exitEditRole(cell, curText);
		  }

		  // Reset Password
		  if (t.classList.contains('btn-reset')) {
			const email = t.dataset.email;
			try {
			  await sendPasswordResetEmail(auth, email);
			  alert('Email reset password dikirim.');
			} catch (err) {
			  console.error(err);
			  alert('Gagal mengirim reset password.');
			}
		  }

		  // Delete (soft)
		  if (t.classList.contains('btn-delete')) {
			const uid = t.dataset.uid;
			if (!confirm('Delete user ini? (Soft delete: akun Auth TIDAK terhapus)')) return;
			try {
			  await updateDoc(doc(db, 'users', uid), { deletedAt: serverTimestamp() });
			  // Hapus baris dari UI
			  const row = t.closest('tr'); row?.parentNode?.removeChild(row);
			} catch (err) {
			  console.error(err);
			  alert('Gagal menghapus user.');
			}
		  }
		});

		// Edit Role — jika user klik dropdown lalu Enter (opsional), tetap butuh Save
		table?.addEventListener('change', (e) => {
		  const sel = e.target;
		  if (sel.classList?.contains('role-select')) {
			// Tidak auto-save. User harus klik Save atau Cancel.
		  }
		});
	  });
	</script>

</body>
</html>
