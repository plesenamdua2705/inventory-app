<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="PSM Inventory">
    <meta name="author" content="Ardhiansyah">

    <title>Forgot Password</title>
	
	<!-- Fav icon -->
	<link rel="icon" href="img/fav.png" type="image/png">

    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

</head>


<body class="bg-gradient-primary">

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-xl-5 col-lg-6 col-md-8">

        <div class="card o-hidden border-0 shadow-lg my-5">
          <div class="card-body p-0">
            <div class="p-5">
              <div class="text-center mb-4">
                <h1 class="h4 text-gray-900 mb-1">Lupa Password</h1>
                <div class="small text-muted">Masukkan email akun Anda. Kami akan kirimkan tautan reset password.</div>
              </div>

              <!-- ALERT -->
              <div id="alertBox" class="alert d-none mb-3" role="alert" aria-live="polite"></div>

              <!-- FORM -->
              <form id="forgotForm" class="user" novalidate>
                <div class="form-group mb-3"><!-- <- jarak bawah -->
                  <label for="email" class="small text-gray-800 mb-1">Email</label>
                  <input id="email" type="email" class="form-control form-control-user"
                         placeholder="nama@perusahaan.com" autocomplete="username" required>
                  <div class="invalid-feedback small">Masukkan email yang valid.</div>
                </div>

                <button id="btnSend" type="submit" class="btn btn-primary btn-user btn-block mt-2" disabled>
                  <span id="btnText">Kirim Tautan Reset</span>
                  <span id="spinner" class="spinner-border spinner-border-sm ml-2 d-none" role="status" aria-hidden="true"></span>
                </button>

                <div class="text-center mt-3">
                  <a href="login_main.html">← Kembali ke Login</a>
                </div>
              </form>

              <hr>
              <div class="text-center small text-muted">© Production System Management 2025</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

    
	<!-- ====== UI Helper (non-module): aktifkan tombol berdasar format email ====== -->
    <script>
		(function () {
		  const form    = document.getElementById('forgotForm');
		  const emailEl = document.getElementById('email');
		  const btnSend = document.getElementById('btnSend');

		  // Regex ringan untuk format email (cukup untuk enable tombol)
		  const emailOk = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v).trim());

		  function validateLight() {
			const valid = emailOk(emailEl.value || '');
			// Toggle style Bootstrap 4
			emailEl.classList.toggle('is-invalid', emailEl.value && !valid);
			btnSend.disabled = !valid; // enable tombol jika format benar
		  }

		  emailEl.addEventListener('input', validateLight);
		  // inisialisasi
		  validateLight();

		  // Jangan cegah submit di helper ini; handler sebenarnya di skrip module.
		})();
    </script>

   <!-- User Page Forgot Pass -->
   <script type="module">
    import { auth, ensureUserDoc } from './js/firebase-init.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";

    
// Refs
    const form     = document.getElementById('forgotForm');
    const emailEl  = document.getElementById('email');
    const btnSend  = document.getElementById('btnSend');
    const btnText  = document.getElementById('btnText');
    const spinner  = document.getElementById('spinner');
    const alertBox = document.getElementById('alertBox');

    let isLoading = false;

    function setLoading(state) {
      isLoading = state;
      btnSend.disabled = state || btnSend.disabled; // tetap disable jika helper memutuskan invalid
      spinner.classList.toggle('d-none', !state);
      btnText.textContent = state ? 'Memproses...' : 'Kirim Tautan Reset';
    }

    function showAlert(type, msg) {
      alertBox.className = `alert alert-${type} mb-3`;
      alertBox.textContent = msg;
      alertBox.classList.remove('d-none');
    }

    function clearAlert() {
      alertBox.classList.add('d-none');
      alertBox.textContent = '';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert();

      // Jika helper masih menilai invalid, hentikan
      if (btnSend.disabled && !isLoading) return;

      try {
        setLoading(true);
        const email = emailEl.value.trim();

        await sendPasswordResetEmail(auth, email);
        showAlert('success', 'Tautan reset password telah dikirim ke email Anda.');
      } catch (err) {
        const code = err?.code || '';
        if (code === 'auth/invalid-email') {
          showAlert('danger', 'Format email tidak valid.');
        } else if (code === 'auth/user-not-found') {
          showAlert('warning', 'Email belum ter‑register di sistem E‑STOCK.');
        } else if (code === 'auth/too-many-requests') {
          showAlert('danger', 'Terlalu banyak percobaan. Coba lagi beberapa menit.');
        } else {
          showAlert('danger', 'Gagal mengirim tautan reset. Coba lagi beberapa saat.');
          console.error('[ForgotPassword]', err);
        }
      } finally {
        setLoading(false);
      }
    });

  </script>
  
</body>
</html>
